version: "3.4"
services:
  db:
    image: mongo:3.6
    volumes:
      - ./:/clashleaders
      - ./mongosnapshot:/docker-entrypoint-initdb.d
  pg:
    image: postgres:11-alpine
    environment:
      - POSTGRES_USER=root
      - POSTGRES_DB=clashleaders
  worker:
    env_file: .env
    volumes:
      - ./clashleaders:/app/clashleaders
      - .ipython/scheduler:/root/.ipython/profile_default
    depends_on:
      - db
  player_worker:
    env_file: .env
    volumes:
      - ./clashleaders:/app/clashleaders
      - .ipython/scheduler:/root/.ipython/profile_default
    depends_on:
      - db
  web:
    env_file: .env
    depends_on:
      - db
      - redis
      - pg
    ports:
      - "8000:80"
    volumes:
      - ./clashleaders:/app/clashleaders
      - ./migrations:/app/migrations
      - ./tests/:/app/tests
      - ./setup.cfg:/app/setup.cfg
      - ./Makefile:/app/Makefile
      - ./caddy/Caddyfile.local:/etc/Caddyfile
      - .ipython/web:/root/.ipython/profile_default

  scheduler:
    env_file: .env
    volumes:
      - ./clashleaders:/app/clashleaders
      - .ipython/scheduler:/root/.ipython/profile_default
    depends_on:
      - db
      - pg
